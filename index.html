<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <script
      src="https://kit.fontawesome.com/04e966dfa0.js"
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div id="frame">
      <div id="mainTimer">
        <select name="programs" id="programs">
          <!--default option-->
          <option value="0">Select exercise</option>
          <option value="1">Sitting Pike Stretch</option>
          <option value="2">Sitting Leg Raise</option>
          <option value="3">Wall V-Sit</option>
          <option value="4">Weighted Jefferson Curl</option>
          <option value="5">Weight. St. Shoulder Extension</option>
          <option value="6">Lying Weigthed Stick Lift</option>
          <option value="7">Pre Side Split</option>
          <option value="8">Horse Stance</option>
          <option value="9">Standing Side Leg Raise</option>
          <option value="10">Pre Front Split</option>
          <option value="11">Wall Quad Hip Flexor Stretch</option>
          <option value="12">Standing Leg Raise</option>
        </select>
        <div class="topTitle">
          <p id="stage">Select exercise</p>
        </div>
        <div>
          <p id="time">00:00</p>
        </div>
        <div class="metaData">
          <div>
            <p class="titleSetCycleTotalTime">Sets</p>
            <p id="sets" class="titleTime">00</p>
          </div>
          <div>
            <p class="titleSetCycleTotalTime">Cycles</p>
            <p id="cycles" class="titleTime">00</p>
          </div>
          <div>
            <p class="titleSetCycleTotalTime">Total time</p>
            <p id="totalTime" class="titleTime">00:00</p>
          </div>
        </div>
        <div class="checkboxDiv">
          <input type="checkbox" id="halfwayBeep" value="halfwayBeep" />
          <label class="checkbox" for="halfwayBeep"
            ><i class="fas fa-stopwatch"></i><span class="checkmark"></span
          ></label>
        </div>
        <!--Bottom line-->
        <div class="navbar">
          <div>
            <button id="startButton" class="navButton">
              <i class="fas fa-play"></i>
            </button>
            <button id="pauseButton" class="navButton" disabled>
              <i class="fas fa-pause"></i>
            </button>
          </div>
          <div class="middleButton">
            <button id="backButton" class="navButton">
              <i class="fas fa-backward"></i>
            </button>
            <button id="forButton" class="navButton">
              <i class="fas fa-forward"></i>
            </button>
          </div>
          <div>
            <button id="clearButton" class="navButton" disabled>
              <i class="fas fa-undo"></i>
            </button>
            <button id="settingsButton" class="navButton">
              <i class="fas fa-cog"></i>
            </button>
          </div>
        </div>
      </div>
      <!--Settings-->
      <div id="settingsBlock">
        <div id="stage2">
          <p>Settings</p>
        </div>
        <div class="settingOptions">
          <p class="exerciseColor">
            Exercise:
            <input
              type="tel"
              id="exerciseIntervalInput"
              onfocus="this.select();"
            />
          </p>
          <p class="restColor">
            Rest:
            <input type="tel" id="restIntervalInput" onfocus="this.select();" />
          </p>
          <p class="numberOfSetsColor">
            Sets:
            <input type="tel" id="numberOfSetsInput" onfocus="this.select();" />
          </p>
          <p class="recoveryColor">
            Recovery:
            <input
              type="tel"
              id="recoveryIntervalInput"
              onfocus="this.select();"
            />
          </p>
          <p class="numberOfCyclesColor">
            Cycles:
            <input
              type="tel"
              id="numberOfCyclesInput"
              onfocus="this.select();"
            />
          </p>
        </div>
        <div class="navbar2">
          <div>
            <button id="settingsBackButton" class="navButton">
              <i class="fas fa-arrow-left"></i>
            </button>
          </div>
          <div>
            <button id="settingsSubmitButton" class="navButton">
              <i class="fas fa-check"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script src="./js/audioPlayer.js"></script>
  <script src="./js/defaultPrograms.js"></script>
  <script src="./js/utils.js"></script>
  <script>
    //what needs to be fixed
    /*
                javascript - refactoring

                the whistle if you put it on horse stance is very low compared to on the rest? why?

                make audio heigher in volume somehow? on phone it cant go that heigh

                was able to align the select bar on my computer but it doesn't show on my phone
                */
    const programsSelect = document.getElementById("programs");
    let interval;
    let totalTime = 0;

    //Settings Inputs
    const exerciseIntervalInput = document.getElementById(
      "exerciseIntervalInput"
    );
    const restIntervalInput = document.getElementById("restIntervalInput");
    const numberOfSetsInput = document.getElementById("numberOfSetsInput");
    const recoveryIntervalInput = document.getElementById(
      "recoveryIntervalInput"
    );
    const numberOfCyclesInput = document.getElementById("numberOfCyclesInput");

    const halfwayBeepButton = document.getElementById("halfwayBeep");

    let arr = [];

    class UI {
      constructor() {
        //Main pages
        this.mainTimer = document.getElementById("mainTimer");
        this.settingsBlock = document.getElementById("settingsBlock");

        //Buttons
        this.startButton = document.getElementById("startButton");
        this.pauseButton = document.getElementById("pauseButton");
        this.clearButton = document.getElementById("clearButton");
        this.backwardsButton = document.getElementById("backButton");
        this.forwardsButton = document.getElementById("forButton");
        this.settingsButton = document.getElementById("settingsButton");
        this.settingsBackButton = document.getElementById("settingsBackButton");
        this.settingsSubmitButton = document.getElementById(
          "settingsSubmitButton"
        );
        this.halfwayBeepButton = document.getElementById("halfwayBeep");

        //Labels
        this.timeLabel = document.getElementById("time");
        this.stageLabel = document.getElementById("stage");
        this.setsLabel = document.getElementById("sets");
        this.cyclesLabel = document.getElementById("cycles");
        this.totalTimeLabel = document.getElementById("totalTime");
        this.totalSetsAndCyclesLabel = document.getElementById(
          "totalSetsAndCycles"
        );
        this.titleSetCycleTotalTimeLabel = document.getElementById(
          "titleSetCycleTotalTime"
        );
        this.programsSelect = document.getElementById("programs");

        // settings inputs
        this.exerciseIntervalInput = document.getElementById(
          "exerciseIntervalInput"
        );
        this.restIntervalInput = document.getElementById("restIntervalInput");
        this.numberOfSetsInput = document.getElementById("numberOfSetsInput");
        this.recoveryIntervalInput = document.getElementById(
          "recoveryIntervalInput"
        );
        this.numberOfCyclesInput = document.getElementById(
          "numberOfCyclesInput"
        );

        //SETTINGS PAGE - changes line by pressing enter
        this.exerciseIntervalInput.addEventListener(
          "keypress",
          keypressHandler(() => restIntervalInput.focus())
        );

        this.restIntervalInput.addEventListener(
          "keypress",
          keypressHandler(() => numberOfSetsInput.focus())
        );

        this.numberOfSetsInput.addEventListener(
          "keypress",
          keypressHandler(() => recoveryIntervalInput.focus())
        );

        this.recoveryIntervalInput.addEventListener(
          "keypress",
          keypressHandler(() => numberOfCyclesInput.focus())
        );

        this.numberOfCyclesInput.addEventListener(
          "keypress",
          keypressHandler(() => this.settingsSubmitButton.click())
        );
      }

      displaySettings() {
        this.mainTimer.style.display = "none";
        this.settingsBlock.style.display = "block";
      }

      hideSettings() {
        this.mainTimer.style.display = "block";
        this.settingsBlock.style.display = "none";
      }

      // UI functions
      timerRunningUIState() {
        this.startButton.style.display = "none";
        this.settingsButton.style.display = "none";
        this.pauseButton.style.display = "inline-block";
        this.clearButton.style.display = "inline-block";
        this.backwardsButton.style.display = "inline-block";
        this.forwardsButton.style.display = "inline-block";
        this.pauseButton.disabled = false;
        this.clearButton.disabled = false;
        this.halfwayBeepButton.disabled = true;
      }

      timerClearedUIState() {
        this.startButton.disabled = false;
        this.halfwayBeepButton.disabled = false;

        this.startButton.style.display = "inline-block";
        this.settingsButton.style.display = "inline-block";
        this.pauseButton.style.display = "none";
        this.clearButton.style.display = "none";
        this.backwardsButton.style.display = "none";
        this.forwardsButton.style.display = "none";

        this.timeLabel.style.color = "white";
        this.stageLabel.style.color = "white";

        this.timeLabel.innerHTML = "00:00";
        this.stageLabel.innerHTML = "Select exercise";
        this.setsLabel.innerHTML = "00";
        this.cyclesLabel.innerHTML = "00";
        this.totalTimeLabel.innerHTML = "00:00";

        this.hideSettings();
      }

      timerPausedUIState() {
        this.startButton.disabled = false;
        this.halfwayBeepButton.disabled = false;
        this.startButton.style.display = "inline-block";
        this.settingsButton.style.display = "none";
        this.pauseButton.style.display = "none";
      }

      updateTimerLabels() {
        this.stageLabel.style.color = arr[index].color;
        this.timeLabel.style.color = arr[index].color;

        this.stageLabel.innerHTML = arr[index].stage;

        this.setsLabel.innerHTML = `${formatSetCycles(arr[index].sets)}`;
        this.cyclesLabel.innerHTML = `${formatSetCycles(arr[index].cycles)}`;

        this.totalTimeLabel.innerHTML = formatTime(totalTime);

        this.timeLabel.innerHTML = formatTime(i);
      }

      onStartButtonClick(clickHandler) {
        this.startButton.addEventListener("click", clickHandler);
      }

      onPauseButtonClick(clickHandler) {
        this.pauseButton.addEventListener("click", clickHandler);
      }

      onClearButtonClick(clickHandler) {
        this.clearButton.addEventListener("click", clickHandler);
      }

      onForwardsButtonClick(clickHandler) {
        this.forwardsButton.addEventListener("click", clickHandler);
      }

      onBackwardsButtonClick(clickHandler) {
        this.backwardsButton.addEventListener("click", clickHandler);
      }

      onSettingsButtonClick(clickHandler) {
        this.settingsButton.addEventListener("click", clickHandler);
      }

      onSettingsBackButtonClick(clickHandler) {
        this.settingsBackButton.addEventListener("click", clickHandler);
      }

      onSettingsSubmitButtonClick(clickHandler) {
        this.settingsSubmitButton.addEventListener("click", clickHandler);
      }

      onProgramsSelectChange(changeHandler) {
        this.programsSelect.addEventListener("change", changeHandler);
      }
    }

    const ui = new UI();

    clear();

    //tick function used when timer
    function tick() {
      if (!arr || arr.length === 0) {
        //when you have select exercise in drop down - nothing in it
        clear(); //default exercise

        return;
      }

      i--;

      //checks if it is the last stage and then stops the timer
      if (i <= 0) {
        index++;
        if (index === arr.length - 1) {
          clear();

          return;
        }
        i = (arr[index] || {}).duration;
      }

      maybePlaySound(i, arr[index], halfwayBeepButton, sounds);
      /*
      let setAmount = arr[index].sets;
      let cycleAmount = arr[index].cycles;
*/
      ui.updateTimerLabels();

      totalTime--;
    }

    //startTimer
    function startTimer() {
      tick();
      interval = setInterval(tick, 1000);
    }

    //start button click
    function startTimerClick(e) {
      ui.timerRunningUIState();

      resetAudioURLs();

      totalTime = calculateTotalTime(arr);
      clearInterval(interval);
      startTimer();
    }

    // reset function
    function clear() {
      clearInterval(interval);
      i = programs[programsSelect.value].initialCountdown;
      index = 0;

      ui.timerClearedUIState();
    }

    // stop & clear button click
    ui.onStartButtonClick(startTimerClick);
    ui.onPauseButtonClick(function () {
      ui.timerPausedUIState();
      clearInterval(interval);
    });

    ui.onForwardsButtonClick(function () {
      clearInterval(interval);
      i = 1;
      totalTime = calculateTotalTime(arr, index + 1);
      startTimer();
    });

    ui.onBackwardsButtonClick(function () {
      clearInterval(interval);
      i = 1;
      index = Math.max(index - 2, -1);
      totalTime = calculateTotalTime(arr, index + 1);
      startTimer();
    });

    ui.onClearButtonClick(clear);

    //Setting buttons
    ui.onSettingsButtonClick(function (e) {
      ui.displaySettings();

      exerciseIntervalInput.focus();
    });

    ui.onSettingsBackButtonClick(function (e) {
      ui.hideSettings();
    });

    ui.onSettingsSubmitButtonClick(function (e) {
      ui.hideSettings();

      const option = document.createElement("option");
      option.value = programsSelect.options.length;
      option.text = `New Exercise: ${exerciseIntervalInput.value || 1}, ${
        restIntervalInput.value || 1
      }, ${numberOfSetsInput.value || 1}`;
      programsSelect.appendChild(option);

      programs.push({
        //New Exercise
        initialCountdown: 7,
        exerciseInterval: parseInt(exerciseIntervalInput.value) || 1,
        restInterval: parseInt(restIntervalInput.value) || 1,
        numberOfSets: parseInt(numberOfSetsInput.value) || 1,
        recoveryInterval: parseInt(recoveryIntervalInput.value) || 1,
        numberOfCycles: parseInt(numberOfCyclesInput.value) || 1,
      });

      programsSelect.value = programsSelect.options.length - 1;
      clear();
      arr = generateExerciseStages(programs[programsSelect.value]);
    });

    ui.onProgramsSelectChange(function () {
      clear();

      arr = generateExerciseStages(programs[programsSelect.value]);
    });
  </script>
  <script src="./js/noSleep.js"></script>
</html>
